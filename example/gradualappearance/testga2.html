<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
    </head>
    <body>
        <div class='rightdiv'>
            <svg width="600" height="600"></svg>
        </div>
        <script src = "{{static_url('./lib/d3.js')}} "></script>

        <script>
            gradualAppearance = function(Visual_proxy, Offset, Repetition, Speed){

                    var loopIndex = 0;
                    var forwardStep = 0
                    var index = 0
                    var repetitionflag = 0
                    var reverse = false
                    var highlightcolor = "black"
                    var intervalStepNum = 1
                    var maxdepth = -1
                    var leaveDepthMap = {}


                    function getPreLeaveDepthSum(depthMap, depth){
                        var depthSum = 0;
                        for (var i = 0; i < depth; i ++) {
                            if(depthMap[i] != undefined)
                                depthSum += 1;
                        };
                        return depthSum;
                    }

                    proxy_clone = Visual_proxy.select(function(){
                        return this.parentNode.insertBefore(this.cloneNode(1), this.nextSibling)
                    })
                        .attr("depthinformation", function(d){
                            if(maxdepth < d.depth){
                                maxdepth = d.depth
                            }
                            if(!d.children){
                                leaveDepthMap[d.depth] = 1
                            }
                            return d.depth
                        })

                    forwardStep = getPreLeaveDepthSum(leaveDepthMap, maxdepth + 1)
                    loopIndex = forwardStep * intervalStepNum;

                    proxy_clone
                        .attr("class", 'lighting')
                        .attr('reverse_delay', function(d){
                            var delayNum = getPreLeaveDepthSum(leaveDepthMap, d.depth);
                            return (forwardStep - delayNum - 1) * intervalStepNum;
                        })
                        .attr('delay', function(d){
                            var delay= getPreLeaveDepthSum(leaveDepthMap, d.depth) * intervalStepNum;            
                            return  Offset + delay; 
                        })
                        .attr('intervalIndex', 0)
                        .attr('inc', 1)
                        .attr('intervalNum', function(d){
                            return intervalStepNum;
                        })
                        .style("fill",  function(d, i){
                            return 'none';
                        });

                    console.log("proxy_clone", proxy_clone)

                    intervalhandler = setInterval(function(){

                        d3.selectAll(".lighting")
                            .style("stroke", function(d){
                                if(d.children)
                                    return 'none'

                                var increaseDelay = +Number(d3.select(this).attr('delay'))            
                                var reverseDelay = +Number(d3.select(this).attr('reverse_delay'))
                                var delay = increaseDelay
                                if(!reverse){  
                                  //forward           
                                  if(index < delay)
                                    return 'none'
                                  else
                                    return highlightcolor//'yellow'                
                                }else{
                                  //backward
                                  delay = reverseDelay
                                  if(index < delay)
                                    return highlightcolor//'yellow'
                                  else
                                    return 'none'
                                }
                                return 'none'
                            })
                            .style('stroke-width', '1.5px')
                            .style('stroke-dasharray', '2 2')

                            index += 1 
  
                            if(!reverse){
                                if(index >= loopIndex + Offset+1){ 
                                    reverse = !reverse
                                    d3.selectAll('.lighting').attr('intervalIndex', 0);     
                                    index = 0
                                    repetitionflag += 1
                                }
                            }
                            else{
                                if(index >= loopIndex){ 
                                    reverse = !reverse
                                    d3.selectAll('.lighting').attr('intervalIndex', 0);     
                                    index = 0
                                    repetitionflag += 1
                                }
                            }


                            if(repetitionflag == Repetition){
                                console.log("#######")
                                clearInterval(intervalhandler)
                                d3.selectAll('.lighting')
                                    .style("stroke", "none")
                            }

                    }, 500 + Speed * 1000 )

                    

                }
        </script>

        <script>
            var svg = d3.select(".rightdiv svg")
            var diameter = svg.attr("width"),
                margin = 10,
                g = svg.append("g").attr("transform","translate(" + diameter/2 + "," + diameter/2 + ")")

            var color = d3.scaleLinear()
                        .domain([-1,5])
                        .range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
                        .interpolate(d3.interpolateHcl)

            var pack = d3.pack()
                        .size([diameter - margin, diameter - margin])

            d3.json("{{static_url('./data/flare.json')}}", function(error, root){
                if(error) throw error

                root = d3.hierarchy(root)
                        .sum(function(d){ return d.size})
                        .sort(function(a,b){
                            return b.value - a.value
                        } )

                var nodes = pack(root).descendants()

                function zoomTo(v){
                    var k = diameter / v[2]

                    d3.selectAll("circle")
                        .attr("transform", function(d){
                            return "translate(" + (d.x - v[0])*k + ","
                                + (d.y - v[1])*k + ")" ;
                        })
                        .attr("r", function(d){ return d.r * k; })
                }

                var circleg = g.selectAll("circle")
                    .data(nodes)
                    .enter()
                    .append("circle")
                    .attr("class", function(d){
                        return (d.parent ? d.children ? "nodes" : "node node--leaf" : "node node--root")
                    })
                    .attr("depth", function(d){
                        return d.depth;
                    })
                    .style("fill", function(d){
                        return color(d.depth)
                    })

                zoomTo([root.x, root.y, root.r * 2 + margin])
                gradualAppearance(circleg, 2, 2, 0.2)
                zoomTo([root.x, root.y, root.r * 2 + margin])
            })
        </script>
    </body>
</html>