<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <script src = "{{static_url('./lib/d3.js')}} "></script>
    </head>
    <body>

        <div class='rightdiv'>
            <svg width="600" height="600"></svg>
        </div>

        <script>

            gradualAppearance = function(Visual_proxy, Offset, Repetition, Speed){
                console.log("speed", Speed)
                console.log("Visual_proxy", Visual_proxy)
                console.log("repetition",Repetition)

                var loopIndex = 0;
                var forwardStep = 0
                var index = 0
                var reverse = false
                var highlightcolor = "black"

                function getPreLeaveDepthSum(depthMap, depth){
                    var depthSum = 0;
                    for (var i = 0; i < depth; i ++) {
                        if(depthMap[i] != undefined)
                            depthSum += 1;
                    };
                    return depthSum;
                }

                forwardStep = getPreLeaveDepthSum(leaveDepthMap, maxDepth + 1)
                loopIndex = forwardStep * intervalStepNum;

                Visual_proxy
                // proxy_clone = Visual_proxy.select(function(){ 
                //         return this.parentNode.appendChild(this.cloneNode(0))
                //     })
                        .append("circle")
                        .attr("class", 'lighting')
                        .attr('reverse_delay', function(d){
                            var delayNum = getPreLeaveDepthSum(leaveDepthMap, d.depth);
                            return Offset["afterOffset"] + (forwardStep - delayNum - 1) * intervalStepNum;
                        })
                        .attr('delay', function(d){
                            var delay= getPreLeaveDepthSum(leaveDepthMap, d.depth) * intervalStepNum;            
                            return  Offset["preOffset"] + delay; 
                        })
                        .attr('intervalIndex', 0)
                        .attr('inc', 1)
                        .attr('intervalNum', function(d){
                            return intervalStepNum;
                        })
                        .style("fill",  function(d, i){
                            return 'none';
                        });

                setInterval(function(){
                    // proxy_clone = Visual_proxy.select(function(){ 
                    //     return this.parentNode.appendChild(this.cloneNode(0))
                    // })

                    d3.selectAll(".lighting")
                        .style("stroke", function(d){
                            if(d.children)
                                return 'none'

                            var increaseDelay = +Number(d3.select(this).attr('delay'))            
                            var reverseDelay = +Number(d3.select(this).attr('reverse_delay'))
                            var delay = increaseDelay
                            if(!reverse){  
                              //forward           
                              if(index < delay)
                                return 'none'
                              else
                                return highlightcolor//'yellow'                
                            }else{
                              //backward
                              delay = reverseDelay
                              if(index < delay)
                                return highlightcolor//'yellow'
                              else
                                return 'none'
                            }
                            return 'none'
                        })
                        .style('stroke-width', '1.5px')
                        .style('stroke-dasharray', '2 2')

                        index += 1 
 
                        if(!reverse){
                            if(index >= loopIndex + Offset["preOffset"]){ 
                                reverse = !reverse
                                d3.selectAll('.lighting').attr('intervalIndex', 0);     
                                index = 0
                                clearInterval()
                            }
                        }
                        else if(reverse){
                            if(index >= loopIndex + Offset["afterOffset"]){ 
                                reverse = !reverse
                                d3.selectAll('.lighting').attr('intervalIndex', 0);     
                                index = 0
                            }
                        }

                }, 500 + Speed * 1000 )
            }
        </script>

        <script>
            var maxDepth = -1
            var leaveDepthMap = {};
            var beginOffSet = 40;
            var endOffSet = 80;
            var smooth = 2;
            var intervalStepNum = 1;
            

            var svg = d3.select(".rightdiv svg")

            var margin = 20,
                diameter = svg.attr("width"),
                g = svg.append("g").attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")") ;

            var color = d3.scaleLinear()
                        .domain([-1, 5])
                        .range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
                        .interpolate(d3.interpolateHcl)

            var color2 = d3.scaleLinear()
                .domain([-1, 5])
              .range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
              .interpolate(d3.interpolateHcl);


            var pack = d3.pack()
                .size([diameter - margin, diameter - margin])
                // .padding(2)

            d3.json("{{static_url('./data/flare.json')}}", function(error, root){
                if(error) throw error ;

                root = d3.hierarchy(root)
                        .sum(function(d){ return d.size; })
                        .sort(function(a, b) { return b.value - a.value; })

                var nodes = pack(root).descendants()

                console.log("nodes", nodes)
            
                if(maxDepth == -1){
                    for (var i = nodes.length - 1; i >= 0; i--) {
                        if(maxDepth < nodes[i].depth)
                            maxDepth = nodes[i].depth;
                        if(!nodes[i].children){
                            leaveDepthMap[nodes[i].depth] = 1;
                        }
                    };
                    console.log(' leave depth map ', leaveDepthMap);
                    console.log("maxDepth", maxDepth)
                }

                function zoomTo(v){
                    var k = diameter / v[2]

                    d3.selectAll("circle")
                        .attr("transform", function(d){
                            return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")"; 
                        })
                        .attr("r", function(d){ return d.r * k})
                }

                var circleg = g.selectAll("circle")
                    .data(nodes)
                    .enter()
                    .append("g") ;

                circleg.append("circle")
                    .attr("class", function(d) { 
                        return (d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"); 
                    })
                    .attr("inc", 1)
                    .attr("depth", function(d){
                        return d.depth;
                    })
                    .style("fill", function(d, i){
                        var cirlcecolor = color2(d.depth)
                        if(d.children)
                            circlecolor = color(d.depth)

                        return circlecolor
                    })

                var offset = {"preOffset": 1, "afterOffset": 3}            
                
                gradualAppearance(circleg,offset,0.1,0.4)

                svg
                    .style("background", 'white')
                    .on("click", function() { zoom(root); });
                zoomTo([root.x, root.y, root.r * 2 + margin])     
            })           
        </script>
    </body>
</html>