<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <style>
            svg{position:absolute;left:0px;top:0px;z-index: -1;}
            canvas{position:absolute;left:0px;top:0px;}
        </style>
    </head>
    <body>

        <script src = "{{static_url('./lib/EventEmitter.js')}} "></script>
        <script src = "{{static_url('./lib/jquery.js')}}"></script>
        <script src = "{{static_url('./lib/jscolor.min.js')}} "></script>
        <script src = "{{static_url('./lib/paper-full.js')}} "></script>
        <script src = "{{static_url('./lib/d3.js')}} "></script>
        <script src = "{{static_url('./src/js/boxplot.js')}}"></script>
        <script src = "{{static_url('./src/js/marchingants.js')}}"></script>

        <canvas id = "aecanvas" width="800" height="800" display=" inline"></canvas>

        <div>
            <svg style="position: absolute; top: 0; left: 0" id="drawsvg"></svg>
        </div>

        <script>
            function autoBoxplotMA(){
                var exampleGroup = {};
                var maGroupMap = {};
                var antDots = [
                    [ 
                        110, 
                        387
                    ], 
                    [ 
                        129, 
                        399
                    ], 
                    [ 
                        129, 
                        405
                    ],    
                    [ 
                        110, 
                        393
                    ], 
                    [ 
                        92, 
                        404
                    ], 
                    [ 
                        91, 
                        400
                    ], 
                    [ 
                        110, 
                        387
                    ]
                ] 

                var mapMaInfo = {};
                var mapMaList = {};

                d3.selectAll('.boxplot')
                    .each(function(d, i){
                
                        var box = d3.select(this).select('.box')
                        var data = JSON.parse(d3.select(this).attr('data'))
                        console.log(" data ", data);
                        var width = +box.attr('width'), height = +box.attr('height')
                        var mline = d3.select(this).select('.mline');
                        var top = (margin.top + (+box.attr('y')));
                        var middlepos = [ d3.select(this).node().getBoundingClientRect().left + (+mline.attr('x1') + width * 0.5),  (margin.top + (+mline.attr('y1')))];

                        console.log(' boxplot ', d3.select(this).attr('groupid'));
                        
                        //upper 
                        var upperma = {};
                        var upppermainfo = {};

                        upppermainfo = {
                          "ae" : "MA",
                          "antcolor" : "#ffffff63",
                          "antshape" : "self-defined",
                          "antgap" : 10,
                          "antinterval" : 2 + Math.pow((data.q3 - data.median - 3), 2),
                        }

                        upperma['path'] = {
                          dots: [middlepos, [middlepos[0], top]]
                        }

                        upperma['boundary'] = {
                          dots: [[middlepos[0] - width/2., top], [middlepos[0] + width/2., top],
                                 [middlepos[0] + width/2., middlepos[1]], [middlepos[0] - width/2., middlepos[1]], [middlepos[0] - width/2., top]]
                        }

                        upppermainfo['groupid'] = d3.select(this).attr('groupid') + '-up'
                        mapMaInfo[upppermainfo['groupid']] = (upppermainfo);
                        mapMaList[upppermainfo['groupid']] = [upperma]

                        var bottomma = {};
                        var bottommainfo = {};

                        bottommainfo = {
                          "ae" : "MA",
                          "antcolor" : "#ffffff63",
                          "antshape" : "self-defined",
                          "antgap" : 10,
                          "antinterval" : 2 + Math.pow((data.median - data.q1 - 3), 2)
                        }

                        bottomma['path'] = {
                          dots: [middlepos, [middlepos[0], top + height]]
                        }

                        bottomma['boundary'] = {
                          dots: [[middlepos[0] - width/2., middlepos[1]], [middlepos[0] + width/2., middlepos[1]],
                                 [middlepos[0] + width/2., top + height], [middlepos[0] - width/2., top + height]]
                        }

                        bottommainfo['groupid'] = d3.select(this).attr('groupid') + '-bo'    
                        mapMaInfo[bottommainfo['groupid']] = (bottommainfo);
                        mapMaList[bottommainfo['groupid']] = [bottomma]
                    })

                    console.log(' liMaInfo ', mapMaInfo);
                    console.log(' mapMaList ', mapMaList);
                    var liGroupId = Object.keys(mapMaInfo);
                    for(var i = 0; i < liGroupId.length; i ++){
                        var groupid = liGroupId[i];
                        maGroupMap[groupid]  = {
                            'mainfo': mapMaInfo[groupid],
                            'malist': mapMaList[groupid],
                        }
                    }

                    return {'antdots': antDots, 'groups': maGroupMap};
            }

            boxplot = function(){
                var imgWidth, imgHeight;
                var largeScreenSizeSetting = {width: 1020, height: 720}
                var smallScreenSizeSetting = {width: 800, height: 600}

                imgWidth = smallScreenSizeSetting.width
                imgHeight = smallScreenSizeSetting.height

                var _svg = d3.selectAll('svg')
                .attr('width', imgWidth)
                .attr('height', imgHeight);

                console.log(' canvas width ', imgWidth, imgHeight);

                var _canvas = d3.select('#aecanvas')
                                .attr('width', imgWidth)
                                .attr('height', imgHeight);

                var canvas = document.getElementById('aecanvas');
                // Create an empty project and a view for the canvas:
                paper.setup(canvas);
                paper.install(window);
                paper.view.draw();

                drawBoxplot();
                var result = autoBoxplotMA();
                var allGroupMap = result['groups']
                var antDots = result['antdots']
                var liGroupId = Object.keys(allGroupMap)

                MA_Start()

                for(var i = 0; i < liGroupId.length; i ++){
                    if(i == liGroupId.length-1){
                        MA_End();
                    }

                    var groupId = liGroupId[i]
                    var tempGroup = allGroupMap[groupId]
                    console.log("tempGroup",tempGroup)
                    var aeInfo = tempGroup["mainfo"]
                    // console.log("aninfo", aeInfo)
                    var malist = tempGroup["malist"]
                    speed = aeInfo["antinterval"]
                    space = aeInfo["antgap"]
                    color = aeInfo["antcolor"]

                    ant = antDots
                    path = malist[0]["path"]["dots"]
                    boundary = malist[0]["boundary"]["dots"]

                    marchingAnt(ant, path, boundary, speed, space, groupId, color, true)
                }
            
            }
        </script>

        <script>
            // this.marchingAnt4 = function(Path, Ant, Interval, Gap, GroupId, Color, AntModal, IstheOne, IsLast){

            //     if(IstheOne == true){
            //         this._functionHub = FunctionHub();
            //     }
                

            //     var malist = []
            //     var aeInfo = {}
            //     var mapGroupIdMaList = {}

            //     if(AntModal != undefined){
            //         var boundry = {"dots": Path}
            //         var path = {"dots": Ant}
            //         malist.push({"boundry": boundry, "path": path})
            //     }
            //     else{
            //         var malistpath = {"geotype":"area", "dots":Path}
            //         var malistant = {"geotype":"area", "dots":Ant}
            //         malist.push({"path": malistpath, "ant": malistant})
            //     }
                 
                
            //     aeInfo["ae"] = "MA"
            //     aeInfo["antcolor"] = Color
            //     aeInfo["antgap"] = Gap
            //     aeInfo["antinterval"] = Interval
            //     aeInfo["groupid"] = GroupId ;
            //     aeInfo["antshape"] = "self-defined"

            //     mapGroupIdMaList["malist"] = malist
            //     mapGroupIdMaList["mainfo"] = aeInfo

            //     // if(AntModal != undefined){
            //     //     this._functionHub.addMAbyGroupwithExampleAnt(mapGroupIdMaList,AntModal)
            //     // }
            //     // else{
            //     //     this._functionHub.addMAbyGroupInfo(mapGroupIdMaList[groupId], drawPath, canvasid)
            //     // }
            //     this._functionHub.addMAbyGroupwithExampleAnt(mapGroupIdMaList,AntModal)
                
            //     if(IsLast == true){
            //         this._functionHub._type = 'animate'
            //         this._functionHub.initFunc()
            //     }  

            // }

            boxplot()
        </script>
    </body>
</html>