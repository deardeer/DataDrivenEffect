<!DOCTYPE html>
<meta charset="utf-8">
<title>Non-Contiguous Cartogram</title>
<style>

.land {
  fill: #fff;
  stroke: #ccc;
}

.state {
  fill: #bad1e3;
  stroke: #88bee2;
}

.randomCircle{
  fill: #67a9cb;
  stroke: #206ba8;
}

.randomLine{
  fill: none;
  stroke: #67a9cb;
}

</style>
<body>
<!-- <script src="//d3js.org/d3.v3.min.js"></script> -->
<script type="text/javascript" src="./d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script type="text/javascript" src="draw/fisheye.js"></script>
<script>


var animate = true
function getR(num){
  if(animate)
    return num / 2.5;
  else
    return num
}

// Ratio of Obese (BMI >= 30) in U.S. Adults, CDC 2008
var valueById = [
   NaN, .187, .198,  NaN, .133, .175, .151,  NaN, .100, .125,
  .171,  NaN, .172, .133,  NaN, .108, .142, .167, .201, .175,
  .159, .169, .177, .141, .163, .117, .182, .153, .195, .189,
  .134, .163, .133, .151, .145, .130, .139, .169, .164, .175,
  .135, .152, .169,  NaN, .132, .167, .139, .184, .159, .140,
  .146, .157,  NaN, .139, .183, .160, .143
];

var mapCarify = {
    'state-26': [639.7850341796875, 153.29983520507812],
    'state-2': [164.0971221923828, 422.4675598144531],
    'state-12': [724.0809936523438, 420.83184814453125],
    'state-30': [323.68780517578125, 89.6788330078125],
}


var mapSize = {
  // 'state-16': 4,
  // 'state-20': 6,
  // 'state-29': 10,
  // 'state-22': 8,
  // 'state-13': 16
}

var stateScatter = [
  {'name': 'state-48',
   'num': 50,},
   {'name': 'state-30',
   'num': 24,},
   {'name': 'state-29',
   'num': 35},
   {'name': 'state-8',
   'num': 10},
   {'name': 'state-6',
   'num': 29},
   {'name': 'state-42',
   'num': 42},
   {'name': 'state-13',
   'num': 38}
]

var path = d3.geo.path();

var svg = d3.select("body").append("svg")
    .attr("width", 960)
    .attr("height", 500);

d3.json("us.json", function(error, us) {
  if (error) throw error;

  svg.append("path")
      .datum(topojson.feature(us, us.objects.land))
      .attr("class", "land")
      .attr("d", path);

  var liStatePath = svg.selectAll(".state")
      .data(topojson.feature(us, us.objects.states).features)
    .enter().append("path")
      .attr("class", "state")
      .attr('id', function(d){
        return 'state-' + d.id;
      })
      .attr("d", path)
      .attr("transform", function(d) {
        var centroid = path.centroid(d),
            x = centroid[0],
            y = centroid[1];
        return "translate(" + x + "," + y + ")"
            + "scale(" + Math.sqrt(0.17 * 5 || 0) + ")"
            + "translate(" + -x + "," + -y + ")";
      })
      .style("stroke-width", function(d) {
        return 1 / Math.sqrt(valueById[d.id] * 5 || 1);
      })

  for(var i = 0; i < stateScatter.length; i ++){
    d3.select('#' + stateScatter[i]['name'])
       .style('fill', 'gray')
       // .style('stroke-width', '2px')
  }

  var liStateCentroid = []
  svg.selectAll(".state").each(function(){

    var path_strAll = d3.select(this).attr('d') 
    var liPos = []   
    var centroidPos = [0,0]   

    if(path_strAll != null){

      var path_str = path_strAll.split('ZM')[0]
      if(path_strAll.split('ZM').length > 1)
        path_str += 'Z'
      
      if(path_str != null){
        var path_strs = path_str.split('L')
        var pos1 = path_strs[0].split('M')[1]
        liPos.push({
          'x': Number(pos1.split(',')[0]), 
          'y': Number(pos1.split(',')[1])
        });
        centroidPos[0] += Number(pos1.split(',')[0])
        centroidPos[1] += Number(pos1.split(',')[1])
          if(isNaN(Number(pos1.split(',')[1]))){
            console.log(' NAN ', pos1)
          }
        for(var i = 1; i < path_strs.length - 1; i ++){
          liPos.push({
            'x': Number(path_strs[i].split(',')[0]), 
            'y': Number(path_strs[i].split(',')[1])
          }) 
          centroidPos[0] += Number(path_strs[i].split(',')[0])
          centroidPos[1] += Number(path_strs[i].split(',')[1])
        }
        var posN = path_strs[path_strs.length - 1].split('Z')[0]
        liPos.push({
          'x': Number(posN.split(',')[0]), 
          'y': Number(posN.split(',')[1])
        })
        centroidPos[0] += Number(posN.split(',')[0])
        centroidPos[1] += Number(posN.split(',')[1])       
      }
      centroidPos[0] /= liPos.length
      centroidPos[1] /= liPos.length
    }

    if(mapCarify[d3.select(this).attr('id')] != undefined){
      centroidPos = mapCarify[d3.select(this).attr('id')]     
    }

    var radius_temp = 3
    if(mapSize[d3.select(this).attr('id')] != undefined){
      radius_temp = mapSize[d3.select(this).attr('id')]
    }
    liStateCentroid.push({
      'id': d3.select(this).attr('id'),
      'pos': centroidPos,
      'radius': radius_temp,
    });


    d3.select(this)
    .attr('lineData', JSON.stringify(liPos))
    .attr('centroidPos', JSON.stringify(centroidPos));
  })
  .on('click', function(e){
    console.log('click', d3.select(this).attr('id'), d3.mouse(this))
  })

  var lineFunction = d3.svg.line()
            .x(function(d){return d.x})
            .y(function(d){return d.y})

  var circleGroup = svg.selectAll('.circle-g')
     .data(stateScatter)
     .enter()
     .append('g')
     .attr('id', function(d){
      return 'circle-g-' + d['name']
     })
     .attr('class', 'circle-g')
     .attr('num', function(d){
      return d['num']
     })
     .attr('centerPos', function(d){
      return d3.select('#' + d['name']).attr('centroidPos')
     })

  for (var i = 0; i < stateScatter.length; i ++) {
    var stateName = stateScatter[i]['name']
    var num = stateScatter[i]['num']
    var centerPos = JSON.parse(d3.select('#' + stateName).attr('centroidPos'))
    var radius_temp = getR(d3.select('#circle-g-' + stateName).attr('num'))
    // var liRandomPos = [];
    for(var j = 0; j < num; j ++){
      // liRandomPos.push([centerPos[0] + 5 * Math.random(), centerPos[1] + 5 * Math.random()])
      // var arc_random =  Math.random() * Math.PI * 2
      var arc_random = Math.PI * 2 * j / num
      var pos_random = [centerPos[0] + radius_temp * Math.cos(arc_random), centerPos[1] + radius_temp * Math.sin(arc_random)]
      d3.select('#circle-g-' + stateName)
                 .append("circle")
                 .attr('class', 'randomCircle')
                 .attr('id', stateName + 'c_' + j)
                 .attr('cx', pos_random[0])
                 .attr('cy', pos_random[1])
                 .attr('oarc', arc_random)
                 .attr('r', 1);    
      d3.select('#circle-g-' + stateName)
                 .append('line')
                 .attr('class', 'randomLine')
                 .attr('id', stateName + 'l_' + j)
                 .attr('oarc', arc_random)
                 .attr('x1', centerPos[0])
                 .attr('y1', centerPos[1])
                 .attr('x2', pos_random[0])
                 .attr('y2', pos_random[1])
                 // .style('stroke', 'gray')

    }    
  };


  svg.selectAll('.state-circle')
     .data(mapCarify)
     .enter()
     // .append('path')     
     .append('circle')
     .attr('class', 'state-circle')
     .attr("id", function(d){
      return d['id'] + '-circle'
     })
     // .attr('d', function(d){
     //  var lipos = [];
     //  var step = 50, radius = 10
     //  for(var j = 0; j < step; j ++){
     //    lipos.push({
     //      'x': d['pos'][0] + 10 * Math.cos(Math.PI * 2 * j / step),
     //      'y': d['pos'][1] + 10 * Math.sin(Math.PI * 2 * j / step)
     //    })
     //  }     
     //  d3.select(this)
     //  .attr('lineData', JSON.stringify(lipos))
     //  d3.select(this)
     //  .attr('center', JSON.stringify(d['pos']))
     //  return lineFunction(lipos)
     // })
     .attr('cx', function(d){
      return JSON.parse(d3.select('#state-' + d['name']).attr('centroidPos'))[0]
     })
     .attr('cy', function(d){
      return JSON.parse(d3.select('#state-' + d['name']).attr('centroidPos'))[1]
     })
     .attr('or', function(d){
      return 3
     })
     .attr('r', function(d){
      return 3
      // if(mapSize[d['id']] != undefined)
        // return mapSize[d['id']]
      
     })

     .style('fill', '#206ba8')
     .style('stroke', 'black');

     // var stateExa = d3.select('#state-40')
     //                  .style('fill', 'red') 
     // var stateRect = stateExa.node()
     // .getBoundingClientRect();

      // stateRect['x'] = JSON.parse(d3.select('#state-40-circle').attr('cx'))
      // stateRect['y'] = JSON.parse(d3.select('#state-40-circle').attr('cy'))
      // stateRect['width'] = 10 * 2
      // stateRect['height'] = 10 * 2

     // svg.append('circle')
     //    .attr('cx', stateRect['x'])
     //    .attr('cy', stateRect['y'])
     //    .attr('r', 5)
     //    .style('fill', 'green')

    // svg.append('circle')
    //     .attr('id', 'bound')
    //     .attr('cx', stateRect['x'])
    //     .attr('cy', stateRect['y'])
    //     .attr('r', stateRect['width'] * 0.5)
    //     .style('fill', 'none')
    //     .style('stroke', 'black')

    // var fisheye = d3.fisheye()
    //                 .radius(stateRect['width'])
                    // .center([stateRect['x'], stateRect['y']])

    // var dir = 1
    var timeIndex = 0
    var currentRatio = 1

    var powerPara = -1.5

    var liTimeIndex = [1, 2, 3, 4, 5, 6, 6, 5, 4, 3, 2, 1];
    
    if(animate == true){
      var interval = setInterval(function(){

          if(timeIndex >= liTimeIndex.length/2.)
            currentRatio -= Math.pow(liTimeIndex[timeIndex] + 0.2, powerPara)
          else
            currentRatio += Math.pow(liTimeIndex[timeIndex] + 0.2, powerPara)

          d3.selectAll('.circle-g')           
            .each(function(){
              var radius = getR(Number(d3.select(this).attr('num'))) * currentRatio
              var centerPos = JSON.parse(d3.select(this).attr('centerPos'));
              d3.select(this)
                .selectAll('.randomCircle')
                .each(function(){
                    var oarc = Number(d3.select(this).attr("oarc"))
                    var pos_random = [centerPos[0] + radius * Math.cos(oarc), centerPos[1] + radius * Math.sin(oarc)]
                    d3.select(this)
                    .attr('cx', pos_random[0])
                    .attr('cy', pos_random[1])
                 })
              d3.select(this)
                .selectAll('.randomLine')
                .each(function(){
                   var oarc = Number(d3.select(this).attr("oarc"))
                    var pos_random = [centerPos[0] + radius * Math.cos(oarc), centerPos[1] + radius * Math.sin(oarc)]               
                  d3.select(this)
                  .attr('x2', pos_random[0])
                  .attr('y2', pos_random[1])
                 })
             })

        
          // if(timeIndex == 2) // liTimeIndex.length/2
          //   clearInterval(interval)
          if(timeIndex == liTimeIndex.length - 1){
            timeIndex = 0
          }else
            timeIndex += 1;

       }, 100);  

    }
     
})

</script>